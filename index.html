<!DOCTYPE html>
<html>

<head>

    <title>Quick Start - Leaflet</title>

    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="shortcut icon" type="image/x-icon" href="docs/images/favicon.ico" />

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.4.0/dist/leaflet.css" integrity="sha512-puBpdR0798OZvTTbP4A8Ix/l+A4dHDD0DGqYW6RQ+9jxkRFclaxxQb/SJAWZfWAkuyeQUytO7+7N4QKrDh+drA=="
        crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.4.0/dist/leaflet.js" integrity="sha512-QVftwZFqvtRNi0ZyCtsznlKSWOStnDORoefr1enyq5mVL4tmKB3S/EnC3rRJcxCPavG10IcrVGSmPh6Qw5lwrg=="
        crossorigin=""></script>

    <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
    <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="./marker.js"></script>

</head>

<body>
    <div id="mapid" style="width: 600px; height: 400px;"></div>
    <script>

        $(document).ready(function () {
            $.ajax({
                type: "GET",
                url: "demo.csv",
                dataType: "text",
                success: function (data) { processData(data); }
            });
        });

        var map = L.map('mapid').setView([55.5, 7.5], 4);


        var geocoder = L.Control.Geocoder.nominatim(),
            control = L.Control.geocoder({
                geocoder: geocoder
            }).addTo(map),
            marker;


        function processData(allText) {
            var lines = [];
            var allTextLines = allText.split(/\r\n|\n/);
            var headers = allTextLines[0].split(',');

            for (var i = 1; i < allTextLines.length; i++) {
                var data = allTextLines[i].split(',');
                if (data.length == headers.length) {
                    const item = {};
                    for (var j = 0; j < headers.length; j++) {
                        item[headers[j].replace(/^\"+|\"+$/g, '')] = data[j].replace(/^\"+|\"+$/g, '');;
                    }
                    lines.push(item);
                }
            }
            console.table(lines);

            // for (var i = 0; i < lines.length; j++) {
            const item = lines[1];
            getMarker(item, geocoder).then(marker => {
                marker.addTo(map);
            });
            // };
        }

        L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycXBndHRqcmZ3N3gifQ.rJcFIG214AriISLbB6B5aw', {
            maxZoom: 18,
            attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, ' +
                '<a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, ' +
                'Imagery Â© <a href="https://www.mapbox.com/">Mapbox</a>',
            id: 'mapbox.streets'
        }).addTo(map);

        map.on('click', onMapClick);

    </script>

</body>

</html>